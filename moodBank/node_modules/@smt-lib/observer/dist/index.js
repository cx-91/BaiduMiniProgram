"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function _createClass(e,t,n){return t&&_defineProperties(e.prototype,t),n&&_defineProperties(e,n),e}var QueueSet=function(){function e(){_classCallCheck(this,e),this.queueSet={}}return _createClass(e,[{key:"get",value:function(e){return this.queueSet[e]||(this.queueSet[e]=[]),this.queueSet[e]}},{key:"pushTo",value:function(e,t){this.get(e).push(t)}},{key:"has",value:function(e){return"[object Array]"===Object.prototype.toString.call(this.queueSet[e])}},{key:"del",value:function(e,t){if("*"===e)this.queueSet={};else if(t){var n=this.get(e).findIndex(function(e){return e.handler===t});this.queueSet[e].splice(n,1)}else this.queueSet[e]=[]}}]),e}(),EventsEmitter=function(){function u(){_classCallCheck(this,u),this.handlerQueueSet=new QueueSet,this.messageQueueSet=new QueueSet}return _createClass(u,[{key:"fireMessage",value:function(t,e){var n=this,r=1<arguments.length&&void 0!==e?e:{};if(!t||!t.type)throw new Error("message error");return this.handlerQueueSet.get(t.type)&&(r.notStore||this.messageQueueSet.pushTo(t.type,t),this.handlerQueueSet.get(t.type).forEach(function(e){n._handlerWrapper(e,t.type,t)}),this.handlerQueueSet.get("*").forEach(function(e){n._handlerWrapper(e,"*",t)})),this}},{key:"onMessage",value:function(e,t,n){var r=this,u=2<arguments.length&&void 0!==n?n:{};if("[object Array]"!==Object.prototype.toString.call(e))return this.handlerQueueSet.pushTo(e,{handler:t,once:u.once}),u.listenPreviousEvent&&this.messageQueueSet.has(e)&&this.messageQueueSet.get(e).forEach(function(e){r._handlerWrapper({handler:t,once:u.once},e.type,e)}),function(){return r.handlerQueueSet.del(e,t)};var a=e.map(function(e){return r.onMessage(e,t,u)});return function(){return a.forEach(function(e){return e()})}}},{key:"delHandler",value:function(e){if(!e)throw new Error("wrong type in delHandler");return this.handlerQueueSet.del(e),this}},{key:"_handlerWrapper",value:function(e,t,n){var r=e.handler,u=e.once;return!!r&&(r.call(this,n),u&&this.handlerQueueSet.del(t,r),!0)}}],[{key:"merge",value:function(){for(var t=new u,e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];return[].concat(n).forEach(function(e){e.onMessage("*",function(e){return t.fireMessage(e)})}),t}}]),u}();module.exports=EventsEmitter;
